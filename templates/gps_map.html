{% load static %}
<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8" />
    <title>Real-time GPS Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      body {
        background-color: #121212;
        color: white;
        margin: 0;
        font-family: sans-serif;
      }
      #map {
        height: 100vh;
        width: 100%;
      }
      #info {
        position: absolute;
        top: 10px;
        left: 10px;
        padding: 6px 12px;
        background: rgba(0,0,0,0.7);
        color: white;
        font-size: 14px;
        z-index: 1000;
        border-radius: 4px;
      }
    </style>
</head>
<body>

<h2 style="text-align:center; margin: 1rem 0;">Real-time GPS Location (Leaflet + AJAX)</h2>
<div id="info">Loading latest GPS data...</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([27.681, 85.32], 13);
  let marker;

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: 'Â© OpenStreetMap',
  }).addTo(map);

  const info = document.getElementById('info');

  async function fetchLatestGPS() {
    try {
      const response = await fetch('{% url "latest_gps_data" %}');
      if (!response.ok) throw new Error('Network response was not ok');

      const data = await response.json();

      info.textContent = `Lat: ${data.latitude.toFixed(5)}, Lng: ${data.longitude.toFixed(5)} | Updated: ${data.timestamp ? new Date(data.timestamp).toLocaleTimeString() : 'N/A'}`;

      const latlng = [data.latitude, data.longitude];

      if (!marker) {
        marker = L.marker(latlng).addTo(map);
      } else {
        marker.setLatLng(latlng);
      }

      // Zoom in to maximum zoom level 19 on marker
      map.setView(latlng, 19);

    } catch (error) {
      console.error('Fetch error:', error);
      info.textContent = 'Error fetching GPS data';
    }
  }

  fetchLatestGPS();
  setInterval(fetchLatestGPS, 200);
</script>

</body>
</html>
